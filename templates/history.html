<!DOCTYPE html>
<html>
<head>
    <title>Your Scan History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='asm-favicon.svg') }}">
</head>
<style>
  body {
    min-height: 100vh;
    background: linear-gradient(135deg, #1f2937, #0ea5e9);
    color: #0b132b;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1.5rem;
    padding-top: 56px; /* offset for fixed-top navbar */
  }
  html { scroll-padding-top: 64px; }
  .page-card { max-width: 900px; width: 100%; background: #fff; border-radius: 16px; box-shadow: 0 20px 40px rgba(2,8,23,.22); overflow: hidden; }
  .page-header { background: linear-gradient(135deg, #0ea5e9, #22c55e); color: #fff; padding: 1rem 1.5rem; display:flex; align-items:center; justify-content:space-between; }
  .page-title { margin:0; font-size:1.25rem; display:flex; align-items:center; gap:.5rem; }
  .brand .badge { background: rgba(255,255,255,.2); border: 1px solid rgba(255,255,255,.35); }
  .page-body { padding: 1.5rem; }
</style>
<body>
  {% include '_navbar.html' %}
  <div class="page-card">
    <div class="page-header">
      <div class="page-title"><span class="brand"><span class="badge text-bg-light">History</span></span></div>
      <div>
        <a href="{{ url_for('index') }}" class="btn btn-outline-light text-dark">New Scan</a>
      </div>
    </div>
    <div class="page-body">
      <h2 class="mb-3">Your Scan History</h2>
      {% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}
      <div class="card mb-3">
        <div class="card-body">
          <form action="{{ url_for('history') }}" method="get" class="row g-2 align-items-end">
            <div class="col-12 col-md-3">
              <label class="form-label" for="start_date">Start date</label>
              <input type="date" id="start_date" name="start_date" value="{{ start_date or '' }}" class="form-control" />
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label" for="end_date">End date</label>
              <input type="date" id="end_date" name="end_date" value="{{ end_date or '' }}" class="form-control" />
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label" for="domain">Domain</label>
              <input type="text" id="domain" name="domain" value="{{ domain_query or '' }}" placeholder="example.com" class="form-control" />
            </div>
            <div class="col-12 col-md-2">
              <label class="form-label" for="severity">Severity</label>
              <select id="severity" name="severity" class="form-select">
                <option value="" {{ '' == (severity or '') and 'selected' or '' }}>Any</option>
                <option value="High" {{ 'High' == (severity or '') and 'selected' or '' }}>High</option>
                <option value="Medium" {{ 'Medium' == (severity or '') and 'selected' or '' }}>Medium</option>
                <option value="Low" {{ 'Low' == (severity or '') and 'selected' or '' }}>Low</option>
              </select>
            </div>
            <div class="col-12 col-md-1 d-grid">
              <button type="submit" class="btn btn-primary">Filter</button>
            </div>
          </form>
        </div>
      </div>
      {% if scans and scans|length > 0 %}
        <table class="table table-striped">
          <thead>
            <tr><th>Date</th><th>Target</th><th>Actions</th></tr>
          </thead>
          <tbody>
            {% for s in scans %}
            <tr>
              <td>{{ s.created_at.strftime('%Y-%m-%d %H:%M UTC') if s.created_at else '' }}</td>
              <td>{{ s.target }}</td>
              <td>
                <a href="{{ url_for('report_scan', scan_id=s._id) }}" class="btn btn-sm btn-outline-primary">View Report</a>
                <a href="{{ url_for('download_pdf', scan_id=s._id) }}" class="btn btn-sm btn-outline-success ms-2">Download PDF</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="d-flex align-items-center justify-content-between">
          <div class="text-muted">Page {{ page }} of {{ (total // per_page) + (1 if total % per_page else 0) }} · Total {{ total }}</div>
          <div>
            {% if has_prev %}
              <a class="btn btn-outline-secondary" href="{{ url_for('history', page=page-1, per_page=per_page, start_date=start_date, end_date=end_date, domain=domain_query, severity=severity) }}">« Previous</a>
            {% else %}
              <button class="btn btn-outline-secondary" disabled>« Previous</button>
            {% endif %}
            {% if has_next %}
              <a class="btn btn-outline-secondary ms-2" href="{{ url_for('history', page=page+1, per_page=per_page, start_date=start_date, end_date=end_date, domain=domain_query, severity=severity) }}">Next »</a>
            {% else %}
              <button class="btn btn-outline-secondary ms-2" disabled>Next »</button>
            {% endif %}
          </div>
        </div>
      {% else %}
        <p class="text-muted">No scans saved yet. Run a scan to populate history.</p>
      {% endif %}
    </div>
  </div>
</body>
</html>